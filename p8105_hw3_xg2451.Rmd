---
title: "p8105_hw3_xg2451"
author: "Xuanyu Guo"
date: "2024-10-08"
output: github_document
---
```{r,warning=FALSE, message=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)
library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
theme_set(theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```
# Problem 1
### 1. Load `ny_noaa` dataset and explore it
```{r}
data("ny_noaa")

num_weather_station <- length(unique(ny_noaa$id))  # number of unique id

wihtoutna_ny_noaa = na.omit(ny_noaa)     # remove NA
num_no_missing <- nrow(wihtoutna_ny_noaa)     
missing_proportion <- (nrow(ny_noaa) - nrow(wihtoutna_ny_noaa))/nrow(ny_noaa)*100   # missing proportion

# missing proportion in each variables
ny_noaa %>% 
  summarise_at(vars(prcp:tmin), .funs = function(x) mean(is.na(x))) %>%
  round(digits = 3) %>%
  knitr::kable()
```

**Description of the raw dataset `ny_noaa`**:

*  The dataset has  `r nrow(ny_noaa)` observations and  `r ncol(ny_noaa)` variables.
*  The variables are :
`id`: Weather station ID, 
`date`: Date of observation, 
`prcp`: Precipitation (tenths of mm), 
`snow`: Snowfall (mm), 
`snwd`: Snow depth (mm), 
`tmax`: Maximum temperature (tenths of degrees C), 
`tmin`: Minimum temperature (tenths of degrees C).
The key variables are `prcp` `snow` `snwd` `tmax` and `tmin`
*  The observations ranging from 1981-01-01 to 2010-12-31. There are `r length(unique(ny_noaa$id))` different weather stations.

**The missing value problem**:

*  There are a total of `r nrow(ny_noaa)-nrow(wihtoutna_ny_noaa)` rows that contains missing data, which accounts for`r (nrow(ny_noaa)-nrow(wihtoutna_ny_noaa))/nrow(ny_noaa)*100`% of the total observations.
*  It means that more than half of the `ny_noaa` data set have missing values.Therefore, missing data is a big issue. 
*  The missing value proportion of the 5 key variables are shown in the table : 44% missing for max and min temperature , 23% for snow depth, 15% for snow, and 6% for precipitation.

### 2. Data Cleaning
```{r}
noaa <- ny_noaa %>%
  janitor::clean_names() %>%
  separate(date, c("year", "month", "day"), sep = "-", convert = TRUE) %>%
  mutate(
    month = month.name[as.integer(month)],
    prcp = prcp / 10,
    tmax = as.numeric(tmax) / 10, 
    tmin = as.numeric(tmin) / 10    # proper units
    )
noaa
```

### 3. The most commonly observed values for snowfall
```{r}
noaa %>% 
  group_by(snow) %>% 
  summarise(frequency = n()) %>%  # count the occurrence of each observed snowfall data
  arrange(desc(frequency))        # arrange the data in descending order to find the most frequent ones
```

The most commonly observed values of snowfall variable in the data set is 0, which implies that there is no snow for most of the time in New York.

One reason for this is that winter only takes up a small proportion of the time range for the observations. And New York almost only snows in winter.

### 4. Plot the average max temperature in January and July
```{r}
noaa %>%
  filter(month == 'January' | month == 'July') %>%
  group_by(month, id, year) %>%
  summarize(mean_tmax = mean(tmax, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = mean_tmax, color = month)) +
  geom_point(alpha = .2) +
  geom_smooth(se = F,color = "red") +    # add red line to show the trend
  facet_grid(~month) +
  labs(x = "Year",
       y = "Average Max Temperature (C)",
       title = "Average Max Temperature in January and July") +
  theme_bw() +
  theme(legend.position = "bottom")
```

**Description**

*  The average max temperature in January is much lower than that in July. 
*  The range of mean tmax in January is around -10 to 10 (degree C), in July is around 20 to 35 (degree C). Thus, Jan has a larger range than July.
*  There are outliers in both January and July. In January, there are extremely low mean tmax lower than -10 and extremely high mean tmax above 10. In July, there are extremely low mean tmax lower than 15.
*  The average mean tmax in January across the years is centered around 0 degree C, while that in July the average is centered around 27 degree C.
*  We can see from the red line that the mean tmax in January fluctuates more wildly than that in July.

### 5. Plot tmax vs tmin + distribution of snowfall
```{r}
tmax_tmin_plot <-                       
  noaa %>% 
  ggplot(aes(x = tmax,y = tmin)) +
  geom_hex() +                            # use hexagon plot
  geom_smooth(se = FALSE,na.rm = TRUE) +
  labs(x = "tmax(C)",y = "tmin(C)",title = "tmax vs tmin") +
  theme(legend.text = element_text(size = 8),
        legend.key.width = unit(1,'cm'))  # set the legend text size and width
  
snow_density_plot <-                    
  noaa %>% 
  filter(snow > 0 & snow < 100) %>%  # greater than 0 and less than 100
  mutate(year = factor(year)) %>% 
  ggplot(aes(x = snow, y = year,fill = year)) + 
  geom_density_ridges() +
  labs(
    y = "Year",
    x = "Snowfall (mm)",
    title = "The distribution of snowfall")  + 
  theme(legend.position = "none")

tmax_tmin_plot + snow_density_plot
```

**Description** 

*  The left figure is a plot of tmax vs tmin from 1980 to 2010. It shows that most of the points fall into the center of the plot, where tmax ranges from 0 to 30 and tmin ranges from -15 to 20.
* The right figure is the distribution of snowfall over the years. Although the distribution of snow are slightly different from year to year, they all share a similar pattern. 
* The pattern shows that : the highest density is between 0 mm to 25 mm, and the lowest is greater than 90 mm. It means that the snowfall is usually between 0 mm to 25 mm and rarely over 90 mm.